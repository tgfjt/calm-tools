---
import '../styles/global.css';
import { css } from '../../styled-system/css';
import { token } from '../../styled-system/tokens';
import { detectLocaleFromHeader, getTranslations } from '../i18n';

interface Props {
  title: string;
  theme?: 'breath' | 'grounding' | 'home';
}

const { title, theme = 'home' } = Astro.props;

// Detect locale from Accept-Language header (SSR)
const acceptLanguage = Astro.request.headers.get('accept-language');
const locale = detectLocaleFromHeader(acceptLanguage);
const i18n = getTranslations(locale);

const bodyStyles = {
  home: css({
    fontFamily: token('fonts.body'),
    minHeight: '100vh',
    display: 'flex',
    justifyContent: 'center',
    alignItems: 'center',
    background: token('gradients.home'),
    color: token('colors.home.secondary'),
  }),
  breath: css({
    fontFamily: token('fonts.body'),
    minHeight: '100vh',
    display: 'flex',
    justifyContent: 'center',
    alignItems: 'center',
    background: token('gradients.breath'),
    color: token('colors.breath.text'),
  }),
  grounding: css({
    fontFamily: token('fonts.body'),
    minHeight: '100vh',
    display: 'flex',
    justifyContent: 'center',
    alignItems: 'center',
    background: token('gradients.grounding'),
    color: token('colors.grounding.text'),
  }),
};

const homeBtnStyles = {
  breath: css({
    position: 'fixed',
    top: '1rem',
    left: '1rem',
    width: '44px',
    height: '44px',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    borderRadius: '50%',
    transition: 'all 0.3s ease',
    zIndex: 100,
    background: token('colors.breath.surfaceHover'),
    border: `1px solid ${token('colors.breath.border')}`,
    color: token('colors.breath.muted'),
    _hover: {
      background: token('colors.breath.surfaceStronger'),
      transform: 'scale(1.05)',
    },
  }),
  grounding: css({
    position: 'fixed',
    top: '1rem',
    left: '1rem',
    width: '44px',
    height: '44px',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    borderRadius: '50%',
    transition: 'all 0.3s ease',
    zIndex: 100,
    background: token('colors.grounding.surfaceWhiteStrong'),
    border: `1px solid ${token('colors.grounding.surfaceWhiteStronger')}`,
    color: token('colors.grounding.textLight'),
    boxShadow: token('shadows.soft'),
    _hover: {
      background: token('colors.grounding.surfaceWhiteMax'),
      color: token('colors.grounding.text'),
      transform: 'scale(1.05)',
    },
  }),
};
---

<!DOCTYPE html>
<html lang={locale} data-locale={locale}>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{theme === 'home' ? title : `${title} - calm`}</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/favicon.svg">
</head>
<body class={bodyStyles[theme]}>
  {theme !== 'home' && (
    <a href="/" class={homeBtnStyles[theme]} aria-label={i18n.common.backToHome}>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
        <polyline points="9 22 9 12 15 12 15 22"/>
      </svg>
    </a>
  )}
  <slot />
</body>
</html>
